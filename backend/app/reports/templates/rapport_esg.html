{% extends "base.html" %}

{% block title %}Rapport ESG{% endblock %}

{% block cover %}
<div class="cover">
  <div class="logo">ESG Advisor</div>
  <div class="subtitle">Plateforme d'accompagnement ESG pour les PME africaines</div>
  <div class="separator"></div>
  <div class="report-title">Rapport d'Évaluation ESG</div>
  <div class="company-name">{{ entreprise.nom }}</div>
  <p class="text-muted">Secteur : {{ entreprise.secteur_activite or 'Non renseigné' }}</p>
  <p class="text-muted">Pays : {{ entreprise.pays or 'Non renseigné' }}</p>
  <div class="date">Généré le {{ date_generation }}</div>
</div>
{% endblock %}

{% block content %}
<!-- ══════════════ Résumé Exécutif ══════════════ -->
<div class="section">
  <h2>Résumé Exécutif</h2>

  {% if resume_llm %}
  <p>{{ resume_llm }}</p>
  {% endif %}

  {% if score %}
  <div class="score-grid">
    <div class="score-card">
      <div class="label">Score Global</div>
      <div class="value {{ score_class(score.score_global) }}">{{ score.score_global }}<span class="max">/100</span></div>
    </div>
    <div class="score-card">
      <div class="label">Environnement</div>
      <div class="value {{ score_class(score.score_e) }}">{{ score.score_e }}<span class="max">/100</span></div>
    </div>
    <div class="score-card">
      <div class="label">Social</div>
      <div class="value {{ score_class(score.score_s) }}">{{ score.score_s }}<span class="max">/100</span></div>
    </div>
    <div class="score-card">
      <div class="label">Gouvernance</div>
      <div class="value {{ score_class(score.score_g) }}">{{ score.score_g }}<span class="max">/100</span></div>
    </div>
  </div>

  <div class="info-box">
    <strong>Référentiel :</strong> {{ score.referentiel_nom or 'N/A' }}<br>
    <strong>Date d'évaluation :</strong> {{ score.created_at[:10] if score.created_at else 'N/A' }}
  </div>
  {% else %}
  <div class="info-box warning">
    Aucune évaluation ESG n'a encore été réalisée pour cette entreprise.
  </div>
  {% endif %}
</div>

<!-- ══════════════ Radar Chart ══════════════ -->
{% if radar_chart %}
<div class="section">
  <h2>Profil ESG</h2>
  <div class="chart-container">
    <img src="data:image/png;base64,{{ radar_chart }}" alt="Radar ESG" />
  </div>
</div>
{% endif %}

<!-- ══════════════ Détail par Pilier ══════════════ -->
{% if details_criteres %}
<div class="section section-break">
  <h2>Détail par Pilier</h2>

  {% for pilier_nom, criteres in details_criteres.items() %}
  <h3>{{ pilier_nom }}</h3>
  <table>
    <thead>
      <tr>
        <th style="width:40%">Critère</th>
        <th style="width:15%">Score</th>
        <th style="width:15%">Poids</th>
        <th style="width:30%">Commentaire</th>
      </tr>
    </thead>
    <tbody>
      {% for c in criteres %}
      <tr>
        <td>{{ c.nom }}</td>
        <td>
          <span class="{{ score_class(c.score) }}">{{ c.score }}/100</span>
        </td>
        <td>{{ c.poids }}%</td>
        <td class="text-sm text-muted">{{ c.commentaire or '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endfor %}
</div>
{% endif %}

<!-- ══════════════ Analyse par Pilier (LLM) ══════════════ -->
{% if analyse_e %}
<div class="section section-break">
  <h2>Analyse Environnement</h2>
  <p>{{ analyse_e }}</p>
</div>
{% endif %}

{% if analyse_s %}
<div class="section">
  <h2>Analyse Social</h2>
  <p>{{ analyse_s }}</p>
</div>
{% endif %}

{% if analyse_g %}
<div class="section">
  <h2>Analyse Gouvernance</h2>
  <p>{{ analyse_g }}</p>
</div>
{% endif %}

<!-- ══════════════ Comparaison Multi-Référentiel ══════════════ -->
{% if comparaison_referentiels %}
<div class="section section-break">
  <h2>Comparaison Multi-Référentiel</h2>
  <p class="text-muted text-sm mb-2">Scores de l'entreprise évalués selon différents référentiels ESG.</p>

  {% if comparison_chart %}
  <div class="chart-container">
    <img src="data:image/png;base64,{{ comparison_chart }}" alt="Comparaison référentiels" />
  </div>
  {% endif %}

  <table>
    <thead>
      <tr>
        <th>Référentiel</th>
        <th>Score E</th>
        <th>Score S</th>
        <th>Score G</th>
        <th>Score Global</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody>
      {% for ref in comparaison_referentiels %}
      <tr>
        <td><strong>{{ ref.referentiel_nom }}</strong></td>
        <td class="{{ score_class(ref.score_e) }}">{{ ref.score_e }}</td>
        <td class="{{ score_class(ref.score_s) }}">{{ ref.score_s }}</td>
        <td class="{{ score_class(ref.score_g) }}">{{ ref.score_g }}</td>
        <td><strong class="{{ score_class(ref.score_global) }}">{{ ref.score_global }}</strong></td>
        <td class="text-muted">{{ ref.created_at[:10] if ref.created_at else '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- ══════════════ Benchmark Sectoriel ══════════════ -->
{% if benchmark %}
<div class="section">
  <h2>Benchmark Sectoriel</h2>
  <div class="info-box">
    <strong>Secteur :</strong> {{ benchmark.secteur }}<br>
    <strong>Score moyen du secteur :</strong> {{ benchmark.score_moyen }}/100<br>
    <strong>Position :</strong>
    {% if score and score.score_global >= benchmark.score_moyen %}
      <span class="badge badge-green">Au-dessus de la moyenne</span>
    {% else %}
      <span class="badge badge-yellow">En dessous de la moyenne</span>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- ══════════════ Historique des Scores ══════════════ -->
{% if evolution_chart %}
<div class="section">
  <h2>Évolution des Scores</h2>
  <div class="chart-container">
    <img src="data:image/png;base64,{{ evolution_chart }}" alt="Évolution scores ESG" />
  </div>
</div>
{% endif %}

<!-- ══════════════ Plan d'Action ══════════════ -->
{% if plan_action %}
<div class="section section-break">
  <h2>Plan d'Action</h2>

  <div class="info-box">
    <strong>Progression globale :</strong> {{ plan_action.pourcentage }}%
    <div class="progress-bar mt-2">
      <div class="fill" style="width: {{ plan_action.pourcentage }}%"></div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:35%">Action</th>
        <th style="width:12%">Priorité</th>
        <th style="width:12%">Statut</th>
        <th style="width:15%">Échéance</th>
        <th style="width:13%">Impact</th>
        <th style="width:13%">Pilier</th>
      </tr>
    </thead>
    <tbody>
      {% for item in plan_action.action_items %}
      <tr>
        <td>{{ item.titre }}</td>
        <td>
          {% if item.priorite == 'quick_win' %}
            <span class="badge badge-green">Quick Win</span>
          {% elif item.priorite == 'moyen_terme' %}
            <span class="badge badge-blue">Moyen terme</span>
          {% else %}
            <span class="badge badge-yellow">Long terme</span>
          {% endif %}
        </td>
        <td>
          {% if item.statut == 'fait' %}
            <span class="badge badge-green">Fait</span>
          {% elif item.statut == 'en_cours' %}
            <span class="badge badge-blue">En cours</span>
          {% else %}
            <span class="badge badge-yellow">À faire</span>
          {% endif %}
        </td>
        <td class="text-sm">{{ item.echeance or '' }}</td>
        <td class="text-sm">+{{ item.impact_estime }} pts</td>
        <td class="text-sm">{{ item.pilier or '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if plan_action_llm %}
<div class="section">
  <h3>Recommandations</h3>
  <p>{{ plan_action_llm }}</p>
</div>
{% endif %}
{% endif %}

<!-- ══════════════ Fonds Verts Recommandés ══════════════ -->
{% if fonds_recommandes %}
<div class="section section-break">
  <h2>Fonds Verts Recommandés</h2>
  <table>
    <thead>
      <tr>
        <th>Fonds</th>
        <th>Institution</th>
        <th>Montant</th>
        <th>Compatibilité</th>
      </tr>
    </thead>
    <tbody>
      {% for f in fonds_recommandes %}
      <tr>
        <td><strong>{{ f.nom }}</strong></td>
        <td>{{ f.institution or '' }}</td>
        <td class="text-sm">{{ f.montant_min_formatted or '' }} – {{ f.montant_max_formatted or '' }}</td>
        <td>
          {% if f.compatibilite >= 80 %}
            <span class="badge badge-green">{{ f.compatibilite }}%</span>
          {% elif f.compatibilite >= 50 %}
            <span class="badge badge-blue">{{ f.compatibilite }}%</span>
          {% else %}
            <span class="badge badge-yellow">{{ f.compatibilite }}%</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}
{% endblock %}
